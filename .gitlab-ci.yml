#image: tiangolo/docker-with-compose

.base_job:
  # image: $CI_IMAGE
  needs: []
  before_script:
    - apk add bash jq git unzip curl
    - pip install pyyaml awscli
    - aws --version && docker --version && docker-compose --version
    - export DD_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.dd_api_key --with-decryption --query "Parameter.Value" --out text)
    - export GL_TOKEN=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.gl_token --with-decryption --query "Parameter.Value" --out text)
    - export CIRCLECI_TOKEN=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.circleci_token --with-decryption --query "Parameter.Value" --out text)
variables:
  # Do not modify this - must be the repository name for Kubernetes gitlab runners to run
   KUBERNETES_SERVICE_ACCOUNT_OVERWRITE: system-tests #helm-charts
   TEST: 1
e2e:
  only:
      - schedules
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/test-infra-definitions/runner:a58cc31c
  tags: ["arch:amd64"]
  before_script:
    - apt-get update
    - apt-get install -y jq
    # Setup AWS Credentials
    - mkdir -p ~/.aws
    - set +x
    - aws ssm get-parameter --region us-east-1 --name ci.system-tests.agent-qa-profile --with-decryption --query "Parameter.Value" --out text >> ~/.aws/config
    - set -x
    - export DD_API_KEY_ONBOARDING=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.dd-api-key-onboarding --with-decryption --query "Parameter.Value" --out text)
    - export DD_APP_KEY_ONBOARDING=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.dd-app-key-onboarding --with-decryption --query "Parameter.Value" --out text)
    - export ONBOARDING_AWS_INFRA_KEYPAIR_NAME=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.aws-infra-keypair-name --with-decryption --query "Parameter.Value" --out text)
    - export ONBOARDING_AWS_INFRA_SUBNET_ID=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.aws-infra-subnet-id --with-decryption --query "Parameter.Value" --out text)
    - export ONBOARDING_AWS_INFRA_SECURITY_GROUPS_ID=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.aws-infra-securiy-groups-id --with-decryption --query "Parameter.Value" --out text)
    - export ONBOARDING_AWS_INFRA_KEY_PATH=$(aws ssm get-parameter --region us-east-1 --name ci.system-tests.aws-infra-key-path --with-decryption --query "Parameter.Value" --out text)

    - export AWS_PROFILE=agent-qa-ci
    - pulumi login --local #"s3://dd-pulumi-state?region=us-east-1&awssdk=v2&profile=$AWS_PROFILE"

  parallel:
      matrix:
        - TEST_LIBRARY: nodejs
  script:
      - echo "Success"
      - ./build.sh -i runner
      - ./run.sh ONBOARDING_HOST
  artifacts:
      when: always
      paths:
        - logs/
        - logs_onboarding_host/