name: "Compute libraries impacted by the change"

on:
  workflow_call:
    outputs:
      libraries_with_dev:
        description: "JSON list of libraries that require a dev run"
        value: ${{ jobs.main.outputs.libraries_with_dev }}
      library_matrix:
        description: "List of couple library + dev/prod to run"
        value: ${{ jobs.main.outputs.library_matrix }}
      desired_execution_time:
        description: "Time in seconds"
        value: ${{ jobs.main.outputs.desired_execution_time }}
      target-branch:
        description: "dd-trace branch to test"
        value: ${{ jobs.main.outputs.target-branch }}
      rebuild_lambda_proxy:
        description: "Should the lambda-proxy image be rebuilt"
        value: ${{ jobs.main.outputs.rebuild_lambda_proxy }}

jobs:
  main:
    runs-on: ubuntu-latest
    outputs:
      library_matrix:  ${{ steps.compute.outputs.library_matrix }}
      libraries_with_dev:  ${{ steps.compute.outputs.libraries_with_dev }}
      desired_execution_time:  ${{ steps.compute.outputs.desired_execution_time }}
      target-branch: ${{ steps.get-target-branch.outputs.target-branch }}
      rebuild_lambda_proxy: ${{ steps.compute.outputs.rebuild_lambda_proxy }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - name: Files changed in PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --paginate --jq '.[].filename' \
            > modified_files.txt
          cat modified_files.txt

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4.9.1
        with:
          python-version: '3.12'
      - name: Compute impacted libraries
        id: compute
        run: python utils/scripts/compute-impacted-libraries.py -o $GITHUB_OUTPUT
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_PR_TITLE: ${{ github.event.pull_request.title }}
      - name: Get target branch
        uses: ./.github/actions/get_target_branch
        id: get-target-branch
        with:
          text: ${{ github.event.pull_request.title }}
      - name: Print results
        run: |
          echo 'Impacted libraries: -> ${{ steps.compute.outputs.library_matrix }}'
          echo 'Desired execution time: -> ${{ steps.compute.outputs.desired_execution_time }}'
          echo 'Target branch: -> ${{ steps.get-target-branch.outputs.target-branch }}'
          echo 'Rebuild lambda-proxy: -> ${{ steps.compute.outputs.rebuild_lambda_proxy }}'
