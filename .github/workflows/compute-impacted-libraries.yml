name: "Compute libraries impacted by the change"

on:
  workflow_call:
    outputs:
      libraries_with_dev:
        description: "JSON list of libraries that require a dev run"
        value: ${{ jobs.main.outputs.libraries_with_dev }}
      library_matrix:
        description: "List of couple library + dev/prod to run"
        value: ${{ jobs.main.outputs.library_matrix }}
      desired_execution_time:
        description: "Time in seconds"
        value: ${{ jobs.main.outputs.desired_execution_time }}
      target-branch:
        description: "dd-trace branch to test"
        value: ${{ jobs.main.outputs.target-branch }}

jobs:
  main:
    runs-on: ubuntu-latest
    outputs:
      library_matrix:  ${{ steps.compute.outputs.library_matrix }}
      libraries_with_dev:  ${{ steps.compute.outputs.libraries_with_dev }}
      desired_execution_time:  ${{ steps.compute.outputs.desired_execution_time }}
      target-branch: ${{ steps.get-target-branch.outputs.target-branch }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - run:  |
          git fetch origin ${{ github.event.pull_request.base.sha || github.sha }}
          git diff --name-only HEAD ${{ github.event.pull_request.base.sha || github.sha }} >> modified_files.txt
          cat modified_files.txt
      - name: Compute impacted libraries
        id: compute
        run: |
          source venv/bin/activate
          python utils/scripts/compute-impacted-libraries.py
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
      - name: Get target branch
        uses: ./.github/actions/get_target_branch
        id: get-target-branch
        with:
          text: ${{ github.event.pull_request.title }}
      - name: Print results
        run: |
          echo 'Impacted libraries: -> ${{ steps.compute.outputs.library_matrix }}'
          echo 'Desired execution time: -> ${{ steps.compute.outputs.desired_execution_time }}'
          echo 'Target branch: -> ${{ steps.get-target-branch.outputs.target-branch }}'
