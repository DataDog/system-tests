name: Update k8s components

on:
  workflow_dispatch: {}
  push:
    paths:
      - '.github/workflows/update_k8s_components.yml' #test the pr
      - 'utils/scripts/update_k8s_pinned_versions.py'
      - 'utils/k8s/k8s_components_parser.py'
      - 'utils/k8s/k8s_components.json'
  schedule:
    - cron: '0 3 * * 0'  # Every Sunday at 3:00 AM UTC

jobs:
  update_k8s_components:
    name: Update k8s components
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      id-token: write

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Install runner
        uses: ./.github/actions/install_runner

      - name: Run script
        id: update_script
        run: |
          chmod +x utils/scripts/update_k8s_pinned_versions.py
          source venv/bin/activate
          if ./utils/scripts/update_k8s_pinned_versions.py; then
            echo "changes_made=true" >> "$GITHUB_OUTPUT"
            echo "Updates were made to k8s components"
          else
            echo "changes_made=false" >> "$GITHUB_OUTPUT"
            echo "No updates needed - all versions are up to date"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        if: steps.update_script.outputs.changes_made == 'true'
        run: |
          # Set the git user.
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add files
        if: steps.update_script.outputs.changes_made == 'true'
        run: |
          git add "utils/k8s/k8s_components.json"

      - name: Variables
        if: steps.update_script.outputs.changes_made == 'true'
        id: vars
        run: |
          BRANCH_NAME="auto-k8s-components-update"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Create branch
        if: steps.update_script.outputs.changes_made == 'true'
        run: |
          echo "Creating branch ${{ steps.vars.outputs.branch_name }}..."
          git checkout -B ${{ steps.vars.outputs.branch_name }}

          echo "Authenticating with GitHub CLI..."
          gh auth setup-git

          echo "Pushing empty branch ${{ steps.vars.outputs.branch_name }}..."
          git push --force-with-lease -u origin ${{ steps.vars.outputs.branch_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create commit
        if: steps.update_script.outputs.changes_made == 'true'
        run: |
          echo "Committing..."
          git commit -m "Update k8s components" --no-verify

      - uses: DataDog/dd-octo-sts-action@acaa02eee7e3bb0839e4272dacb37b8f3b58ba80 # v1.0.3
        if: steps.update_script.outputs.changes_made == 'true'
        id: octo-sts
        with:
          scope: DataDog/system-tests
          policy: self.k8s_components

      - name: Push signed commits
        if: steps.update_script.outputs.changes_made == 'true'
        uses: Asana/push-signed-commits@d615ca88d8e1a946734c24970d1e7a6c56f34897
        with:
          github-token: ${{ steps.octo-sts.outputs.token }}
          repo: DataDog/system-tests
          local_branch_name: ${{ steps.vars.outputs.branch_name }}
          remote_name: origin
          remote_branch_name: ${{ steps.vars.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.update_script.outputs.changes_made == 'true'
        run: |
          BRANCH_NAME="${{ steps.vars.outputs.branch_name }}"

          # Create or reference PR
          if gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' | grep -q .; then
            PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
            echo "PR already exists: #$PR_NUMBER"
          else
            gh pr create \
              --title "Auto-update k8s components" \
              --body "Automated update of k8s components" \
              --head "$BRANCH_NAME" \
              --base main
          fi
        env:
          GITHUB_TOKEN: ${{ steps.octo-sts.outputs.token }}