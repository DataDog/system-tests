import jsonschema
import json
from pathlib import Path
from utils import interfaces, features


@features.iast_schema
class TestIastVulnerabilitySchema:
    def test_vulnerability_schema(self):
        schema_path = Path(__file__).parent / "vulnerability_schema.json"
        with open(schema_path, "r") as f:
            schema = json.load(f)
        validator = jsonschema.Draft7Validator(schema)
        spans_with_format = list(interfaces.library.get_root_spans())
        for _, span, span_format in spans_with_format:
            meta = interfaces.library.get_span_meta(span, span_format)
            if "_dd.iast.json" not in meta:
                continue
            iast_data = meta["_dd.iast.json"]
            validation_errors = list(validator.iter_errors(iast_data))
            assert not validation_errors, f"Invalid IAST data for span: {iast_data}"
