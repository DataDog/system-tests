FROM public.ecr.aws/docker/library/ruby:3.2

ENV DEBIAN_FRONTEND=noninteractive

# Install prerequisites
RUN set -ex && \
  echo "===> Installing dependencies" && \
  apt-get -y update && \
  apt-get install -y --force-yes --no-install-recommends \
      curl wget tar gzip gnupg apt-transport-https ca-certificates tzdata locales && \
  \
  echo "===> Installing database libraries" && \
  apt-get install -y --force-yes --no-install-recommends sqlite3 && \
  \
  echo "===> Installing dev tools" && \
  mkdir -p /usr/share/man/man1 && \
  apt-get install -y --force-yes --no-install-recommends \
      sudo git openssh-client rsync vim \
      net-tools netcat-traditional parallel unzip zip bzip2 && \
  \
  echo "===> Cleaning up" && \
  rm -rf /var/lib/apt/lists/*;

# Set timezone to UTC by default
RUN ln -sf /usr/share/zoneinfo/Etc/UTC /etc/localtime

# Upgrade RubyGems and Bundler
RUN gem update --system 3.4.1

RUN mkdir -p "$GEM_HOME" && chmod -R 777 "$GEM_HOME"
ENV BUNDLE_SILENCE_ROOT_WARNING 1

# Setup directory
RUN mkdir /app
WORKDIR /app

# Add files
COPY lib_injection_rails_app /app

# Replace the incompatible bigdecimal version constraint
RUN sed -i "s|gem 'bigdecimal', '~> 1.2', '>= 1.2.7'|gem 'bigdecimal', '>= 3.1.0'|" Gemfile
# Add/replace nio4r constraint
RUN grep -q "gem 'nio4r'" Gemfile || echo "gem 'nio4r', '>= 2.5.9'" >> Gemfile

# Install gems
RUN bundle install

# Set entrypoint
ENTRYPOINT ["/bin/bash", "-c"]

CMD ["bin/rails server -b 0.0.0.0 -p 18080"]
