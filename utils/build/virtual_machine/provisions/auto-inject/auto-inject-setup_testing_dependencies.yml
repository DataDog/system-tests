#Pull the right docker images & install crane
#Itâ€™s required to do the "if custom version present then use it else fallback to latest" & to auth to the QA registry
- os_type: linux
  os_distro: deb
  remote-command: |
    sudo rm -rf /usr/local/go
    sudo curl https://dl.google.com/go/go1.22.1.linux-$(dpkg --print-architecture).tar.gz --output go.tar.gz
    sudo tar -C /usr/local -xzf go.tar.gz
    export PATH=$PATH:/usr/local/go/bin
    export PATH=$PATH:$(go env GOPATH)/bin
    go install github.com/google/go-containerregistry/cmd/crane@latest
    go install github.com/awslabs/amazon-ecr-credential-helper/ecr-login/cli/docker-credential-ecr-login@latest
    sudo mkdir -p ~/.docker
    echo '{"credHelpers":{"669783387624.dkr.ecr.us-east-1.amazonaws.com": "ecr-login"}}' | sudo tee ~/.docker/config.json
    sudo mkdir -p /root/.docker
    echo '{"credHelpers":{"669783387624.dkr.ecr.us-east-1.amazonaws.com": "ecr-login"}}' | sudo tee /root/.docker/config.json
    sudo PATH="$PATH:$(/usr/local/go/bin/go env GOPATH)/bin" docker pull 669783387624.dkr.ecr.us-east-1.amazonaws.com/dockerhub/library/registry:2
- os_type: linux
  os_distro: rpm
  remote-command: |
    sudo rm -rf /usr/local/go
    sudo curl https://dl.google.com/go/go1.22.1.linux-$(rpm --eval '%{_arch}' | sed s/aarch64/arm64/ | sed s/x86_64/amd64/).tar.gz --output go.tar.gz
    sudo tar -C /usr/local -xzf go.tar.gz
    export PATH=$PATH:/usr/local/go/bin
    export PATH=$PATH:$(go env GOPATH)/bin
    go install github.com/google/go-containerregistry/cmd/crane@latest
    go install github.com/awslabs/amazon-ecr-credential-helper/ecr-login/cli/docker-credential-ecr-login@latest
    sudo mkdir -p ~/.docker
    echo '{"credHelpers":{"669783387624.dkr.ecr.us-east-1.amazonaws.com": "ecr-login"}}' | sudo tee ~/.docker/config.json
    sudo mkdir -p /root/.docker
    echo '{"credHelpers":{"669783387624.dkr.ecr.us-east-1.amazonaws.com": "ecr-login"}}' | sudo tee /root/.docker/config.json
    sudo PATH="$PATH:$(/usr/local/go/bin/go env GOPATH)/bin" docker pull 669783387624.dkr.ecr.us-east-1.amazonaws.com/dockerhub/library/registry:2