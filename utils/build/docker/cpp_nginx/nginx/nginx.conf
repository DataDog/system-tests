load_module modules/ngx_http_datadog_module.so;

events {
    worker_connections  1024;
}

http {
    datadog_trace_locations off;

    server {
        listen       7777;
        server_name  0.0.0.0;

        # `return` directives are not traced
        # See, <https://github.com/DataDog/nginx-datadog/issues/58>
        location ~* /sample_rate/([0-9]+) {
          root /builds;
          try_files /hello.html =404;
        }

        location /mysql {
          # can't use `return`
          try_files /non_existent =404;
		}

        location /healthcheck {
          root /builds;
          try_files /healthcheck.json =404;
        }

        location =/read_file {
            limit_except GET {
                deny all;
            }
            if ($arg_file = "") {
                return 400 "Bad Request: 'file' parameter is required.";
            }

            proxy_pass http://127.0.0.1:7778;
        }

        location ~ ^/sample_rate_route/\d+$ {
               rewrite ^/sample_rate_route/\d+$ /content?status=200&value=Hello+world! break;
               proxy_pass http://127.0.0.1:7778;
        }

        location / {
          root /builds;
          try_files /hello.html =404;
        }
    }
}
